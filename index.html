<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Guia completo para aprovação no ENEM 2026. Plataforma de estudos com IA conectada, Cronogramas e Estratégias.">
    <meta name="theme-color" content="#020617">
    <title>Guia do Estudante: A Jornada | Alessandro Mozer</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- NOTA: Tailwind via CDN é usado aqui apenas para prototipagem rápida/demo em arquivo único. 
         Em produção, deve-se usar o build process do Tailwind (PostCSS) para performance e purge CSS. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-deep: #020617;
            --rose-primary: #e11d48;
            --rose-glow: rgba(225, 29, 72, 0.4);
            --glass-bg: rgba(15, 23, 42, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
        }
        
        body { background-color: var(--bg-deep); color: #e2e8f0; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; border: 2px solid var(--bg-deep); }
        ::-webkit-scrollbar-thumb:hover { background: var(--rose-primary); }

        /* UI Elements & Glassmorphism */
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
        
        /* FIX: Background attachment fixed causa problemas graves de performance/scroll em mobile. 
           Usamos 'scroll' em telas pequenas. */
        .hero-bg { 
            background: linear-gradient(to bottom, transparent, var(--bg-deep)), linear-gradient(to right, rgba(2,6,23,0.95), rgba(2,6,23,0.7)), url('https://images.unsplash.com/photo-1522202176988-66273c2fd55f?auto=format&fit=crop&q=80&w=2000'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
        }
        @media (max-width: 768px) {
            .hero-bg { background-attachment: scroll; }
        }

        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        /* Hover apenas em dispositivos que suportam hover para evitar sticky state em mobile */
        @media (hover: hover) {
            .card-hover:hover { transform: translateY(-5px); border-color: var(--rose-primary); box-shadow: 0 10px 30px -10px var(--rose-glow); }
        }
        
        /* Animations */
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Markdown Styling */
        .prose-chat p { margin-bottom: 0.8rem; line-height: 1.6; }
        .prose-chat strong { color: #fff; font-weight: 700; }
        .prose-chat ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.8rem; }
        .prose-chat a { color: #fb7185; text-decoration: underline; }
        .source-chip { display: inline-flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 6px; font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; text-decoration: none !important; margin-right: 6px; margin-top: 6px; }
        
        /* Utilities */
        .touch-target { min-height: 48px; min-width: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        
        /* Mobile Modal Tabs */
        .modal-tab-active { border-bottom: 2px solid #e11d48; color: white; }
        .modal-tab-inactive { color: #94a3b8; }
    </style>
</head>
<body class="selection:bg-rose-600 selection:text-white relative">

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" aria-live="polite" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-xs px-4 pointer-events-none"></div>

    <!-- NAV BAR -->
    <nav class="fixed w-full z-50 glass-panel border-b-0 top-0 transition-all duration-300 shadow-lg" aria-label="Navegação Principal">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 md:h-20">
                <!-- Logo -->
                <a href="#" id="logo-btn" class="flex items-center gap-3 group focus:outline-none focus:ring-2 focus:ring-rose-500 rounded-lg p-1">
                    <div class="w-10 h-10 bg-rose-600 rounded-lg flex items-center justify-center shadow-lg shadow-rose-900/50 group-hover:scale-110 transition duration-300">
                        <i class="fas fa-play text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black tracking-tighter italic text-white leading-none">JORNADA</h1>
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block group-hover:text-white transition">Alessandro Mozer</span>
                    </div>
                </a>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center gap-6">
                    <div class="relative group">
                        <label for="desktop-search" class="visually-hidden">Buscar episódio</label>
                        <input type="text" id="desktop-search" placeholder="Buscar episódio..." class="bg-slate-900/50 border border-white/10 rounded-full py-2 pl-10 pr-4 text-xs w-48 focus:w-64 transition-all focus:border-rose-500 focus:outline-none text-white focus:bg-slate-900">
                        <i class="fas fa-search absolute left-3.5 top-2.5 text-slate-500 text-xs" aria-hidden="true"></i>
                    </div>

                    <div class="h-6 w-px bg-white/10 mx-2" aria-hidden="true"></div>

                    <!-- Gamification Stats -->
                    <div class="flex items-center gap-5 text-xs font-bold uppercase tracking-wide text-slate-400" role="status">
                        <div class="flex items-center gap-1.5 cursor-help hover:text-white transition" title="Dias seguidos" tabindex="0">
                            <i class="fas fa-fire text-orange-500 text-sm" aria-hidden="true"></i> <span id="streak-counter">0</span> <span class="sr-only">dias seguidos</span> Dias
                        </div>
                        <div class="flex items-center gap-1.5 cursor-help hover:text-white transition" title="Nível" tabindex="0">
                            <i class="fas fa-trophy text-yellow-500 text-sm" aria-hidden="true"></i> <span id="user-level">Novato</span>
                        </div>
                    </div>

                    <button id="btn-tools-desktop" class="text-slate-300 hover:text-white transition p-2 hover:bg-white/5 rounded-full touch-target" aria-label="Abrir Ferramentas">
                        <i class="fas fa-toolbox text-lg"></i>
                    </button>
                    <button id="btn-chat-desktop" class="bg-gradient-to-r from-rose-600 to-rose-500 hover:from-rose-500 hover:to-rose-400 text-white px-6 py-2.5 rounded-full transition shadow-lg shadow-rose-900/20 text-xs font-bold flex items-center gap-2 hover:scale-105 active:scale-95 border border-white/10">
                        <i class="fas fa-globe" aria-hidden="true"></i> Mentor IA
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <button id="btn-mobile-menu" class="md:hidden text-white text-xl p-2 touch-target hover:bg-white/5 rounded-lg transition" aria-label="Abrir Menu Principal" aria-expanded="false">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <!-- Global Progress Line -->
        <div class="w-full h-1 bg-slate-800 relative group cursor-pointer" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="Progresso Total do Curso">
            <div id="global-progress-line" class="h-full bg-gradient-to-r from-rose-600 to-orange-500 w-0 transition-all duration-1000 relative shadow-[0_0_15px_rgba(225,29,72,0.5)]"></div>
        </div>
    </nav>

    <!-- MOBILE MENU DRAWER -->
    <div id="mobile-menu-overlay" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-sm hidden transition-opacity" aria-hidden="true"></div>
    <div id="mobile-menu" class="fixed inset-y-0 right-0 z-50 w-[85%] max-w-sm bg-[#050505] border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col backdrop-blur-xl" aria-hidden="true">
        <div class="p-6 flex justify-between items-center border-b border-white/10 bg-slate-900/50">
            <span class="text-white font-bold text-xl tracking-widest italic">MENU</span>
            <button id="btn-close-mobile" class="text-white text-2xl touch-target hover:text-rose-500 transition" aria-label="Fechar Menu"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-6 flex-grow overflow-y-auto">
            <label for="mobile-search" class="visually-hidden">Pesquisar</label>
            <input type="text" id="mobile-search" placeholder="O que você quer aprender?" class="w-full bg-slate-800 border border-white/10 rounded-xl py-4 px-4 text-white mb-8 focus:border-rose-500 focus:outline-none focus:ring-1 focus:ring-rose-500 transition">

            <nav class="flex flex-col gap-2 text-lg font-bold text-slate-300">
                <button class="nav-link-mobile flex items-center gap-4 hover:text-white hover:bg-white/5 p-3 rounded-xl transition w-full text-left" data-target="catalogo"><i class="fas fa-list w-6 text-center text-rose-500"></i> Catálogo</button>
                <button class="nav-link-mobile flex items-center gap-4 hover:text-white hover:bg-white/5 p-3 rounded-xl transition w-full text-left" data-action="favorites"><i class="fas fa-heart w-6 text-center text-rose-500"></i> Favoritos</button>
                <button class="nav-link-mobile flex items-center gap-4 hover:text-white hover:bg-white/5 p-3 rounded-xl transition w-full text-left" data-action="tools"><i class="fas fa-calculator w-6 text-center text-rose-500"></i> Ferramentas</button>
                <button class="nav-link-mobile flex items-center gap-4 hover:text-white hover:bg-white/5 p-3 rounded-xl transition w-full text-left" data-action="chat"><i class="fas fa-globe w-6 text-center text-rose-500"></i> Mentor Conectado</button>
            </nav>
        </div>
    </div>

    <!-- HERO SECTION -->
    <header id="home" class="relative min-h-[92vh] flex items-center justify-center hero-bg px-4 py-20">
        <div class="text-center max-w-5xl mx-auto pt-10 animate-fade-in">
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass-panel border border-rose-500/30 mb-8 hover:bg-white/5 transition cursor-default shadow-lg">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <span class="text-[10px] md:text-xs font-bold uppercase tracking-widest text-rose-200">IA Conectada • Conteúdo Atualizado 2026</span>
            </div>
            
            <h1 class="text-5xl md:text-8xl font-black text-white leading-[0.9] tracking-tighter mb-8 drop-shadow-2xl">
                SUA JORNADA <br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-rose-500 via-rose-400 to-orange-400">CONECTADA AO MUNDO.</span>
            </h1>
            
            <p class="text-base md:text-xl text-slate-300 max-w-2xl mx-auto leading-relaxed mb-10 font-light px-4">
                A plataforma definitiva para o ENEM. <strong>10 Temporadas completas</strong>, Repertório Sociocultural, Ferramentas de Estudo e uma IA que pesquisa na internet para tirar suas dúvidas em tempo real.
            </p>

            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 w-full px-4">
                <button id="btn-start-hero" class="w-full sm:w-auto bg-rose-600 hover:bg-rose-700 text-white px-8 py-4 rounded-xl font-bold text-sm tracking-wide transition transform hover:scale-105 shadow-[0_0_20px_rgba(225,29,72,0.4)] flex items-center justify-center gap-3 border border-white/10 touch-target focus:ring-2 focus:ring-white">
                    <i class="fas fa-play" aria-hidden="true"></i> INICIAR MARATONA
                </button>
                <button id="btn-chat-hero" class="w-full sm:w-auto glass-panel hover:bg-white/10 text-white px-8 py-4 rounded-xl font-bold text-sm transition border border-white/10 flex items-center justify-center gap-3 hover:scale-105 touch-target focus:ring-2 focus:ring-white">
                    <i class="fas fa-search" aria-hidden="true"></i> PESQUISAR NO GOOGLE IA
                </button>
            </div>
        </div>
    </header>

    <!-- CATÁLOGO PRINCIPAL -->
    <main id="catalogo" class="max-w-7xl mx-auto px-4 md:px-8 py-24 space-y-28">
        <div id="catalog-loader" class="text-center text-slate-500 animate-pulse py-20">
            <i class="fas fa-circle-notch fa-spin text-4xl mb-4 text-rose-600"></i>
            <p class="uppercase tracking-widest font-bold text-xs">Carregando temporadas...</p>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="border-t border-white/5 bg-[#010101] py-24 px-4 text-center">
        <div class="max-w-3xl mx-auto space-y-8">
            <h2 class="text-4xl font-black italic tracking-tighter text-slate-800 select-none">JORNADA</h2>
            <p class="text-slate-500 text-sm leading-relaxed">Desenvolvido com rigor pedagógico por <strong>Alessandro Mozer</strong>.<br>Conteúdo atualizado em tempo real via IA e Google Grounding.</p>
            <p class="text-[10px] text-slate-800 font-bold uppercase tracking-widest mt-12 opacity-50">© 2026 Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- MODAL DE EPISÓDIO (ARQUITETURA MOBILE APP) -->
    <div id="episode-modal" class="fixed inset-0 z-[60] hidden opacity-0 transition-opacity duration-300 flex items-center justify-center p-0 md:p-6 backdrop-blur-sm" aria-modal="true" role="dialog" aria-labelledby="modal-title">
        <div class="absolute inset-0 bg-black/95" id="modal-backdrop"></div>
        
        <div id="modal-content-box" class="relative bg-slate-900 w-full h-full md:rounded-3xl border border-white/10 shadow-2xl flex flex-col md:flex-row overflow-hidden animate-fade-in transition-all duration-300 max-w-[1600px]">
            
            <!-- Header Mobile (Só aparece em telas pequenas) -->
            <div class="md:hidden flex justify-between items-center p-4 border-b border-white/10 bg-slate-950">
                <span class="text-rose-500 text-[10px] font-bold uppercase tracking-widest" id="modal-tag-mobile">TEMP 1</span>
                <button id="btn-close-modal-mobile" class="text-white text-xl touch-target" aria-label="Fechar"><i class="fas fa-times"></i></button>
            </div>

            <!-- Controles Desktop -->
            <div class="absolute top-4 right-4 z-50 hidden md:flex gap-2">
                <button id="btn-fullscreen" class="w-10 h-10 bg-black/50 hover:bg-white/10 rounded-full text-white flex items-center justify-center transition backdrop-blur-md border border-white/10 touch-target" aria-label="Tela Cheia"><i class="fas fa-expand"></i></button>
                <button id="btn-close-modal-desktop" class="w-10 h-10 bg-black/50 hover:bg-rose-600 rounded-full text-white flex items-center justify-center transition backdrop-blur-md border border-white/10 touch-target" aria-label="Fechar"><i class="fas fa-times"></i></button>
            </div>

            <!-- Sidebar / Tab Content 1 (Ferramentas e Info) -->
            <div id="modal-sidebar" class="w-full md:w-96 bg-[#0a0a0a] p-6 md:p-8 flex flex-col border-r border-white/5 shrink-0 overflow-y-auto custom-scrollbar md:h-full hidden md:flex">
                <div class="mb-8">
                    <span id="modal-tag" class="text-rose-500 text-[10px] font-bold uppercase tracking-[0.2em] mb-3 hidden md:block">TEMPORADA 1</span>
                    <h2 id="modal-title" class="text-2xl md:text-3xl font-black text-white mb-6 leading-tight">Título do Episódio</h2>
                    
                    <div class="flex flex-wrap gap-3">
                        <button id="btn-fav" class="px-3 py-1.5 bg-white/5 rounded-lg text-[10px] uppercase font-bold text-slate-400 border border-white/5 hover:text-rose-500 hover:border-rose-500/30 transition flex items-center gap-2 touch-target">
                            <i class="far fa-heart"></i> Favoritar
                        </button>
                    </div>
                </div>

                <div class="space-y-4 mb-10">
                    <button id="btn-concluir" class="w-full py-4 bg-slate-800 hover:bg-green-600 text-white rounded-xl font-bold text-xs uppercase tracking-widest transition flex items-center justify-center gap-3 border border-white/5 shadow-lg group touch-target">
                        <i class="far fa-circle group-hover:scale-110 transition"></i> Concluir Episódio
                    </button>
                    <a id="modal-link-video" href="#" target="_blank" class="w-full py-4 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold text-xs uppercase tracking-widest transition flex items-center justify-center gap-3 shadow-[0_0_20px_rgba(225,29,72,0.3)] hover:shadow-[0_0_30px_rgba(225,29,72,0.5)] touch-target">
                        <i class="fab fa-youtube"></i> Assistir Aula
                    </a>
                </div>

                <div class="mt-auto space-y-6 pt-6 border-t border-white/5">
                    <div class="bg-slate-900 p-5 rounded-2xl border border-white/5 shadow-inner">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-stopwatch"></i> Focus Timer</span>
                            <span id="pomo-display" class="text-xl font-mono font-bold text-white tracking-widest">25:00</span>
                        </div>
                        <div class="flex gap-2">
                            <button id="pomo-btn" class="flex-1 py-2 bg-slate-800 text-[10px] text-rose-400 font-bold rounded-lg hover:bg-slate-700 transition uppercase tracking-wide touch-target">Iniciar</button>
                            <button id="pomo-reset" class="py-2 px-3 bg-slate-800 text-slate-400 rounded-lg hover:bg-slate-700 transition touch-target" aria-label="Resetar Timer"><i class="fas fa-redo text-xs"></i></button>
                        </div>
                    </div>
                    
                    <div class="mb-20 md:mb-0">
                        <div class="flex justify-between items-center mb-3">
                            <label for="user-notes" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-pen"></i> Anotações</label>
                            <button id="btn-save-notes" class="text-[10px] text-rose-500 hover:text-white uppercase font-bold flex items-center gap-1 transition touch-target"><i class="fas fa-download"></i> Salvar</button>
                        </div>
                        <textarea id="user-notes" class="w-full h-32 bg-slate-900 border border-white/10 rounded-xl p-4 text-xs text-slate-300 focus:outline-none focus:border-rose-500 focus:text-white resize-none font-mono leading-relaxed transition placeholder-slate-600" placeholder="Digite seus insights aqui..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Main Content / Tab Content 2 (Texto) -->
            <div id="modal-main-content" class="flex-grow bg-[#050505] flex flex-col relative order-1 md:order-2 h-full">
                <div class="flex-grow overflow-y-auto custom-scrollbar p-6 md:p-16 pb-24 md:pb-16 scroll-smooth" id="modal-scroll-area">
                    <div id="modal-body" class="prose prose-invert prose-lg max-w-4xl mx-auto text-slate-300 leading-loose"></div>
                    
                    <div class="mt-16 pt-10 border-t border-white/5 max-w-4xl mx-auto">
                        <a id="modal-link-source" href="#" target="_blank" class="flex items-center gap-3 text-slate-500 hover:text-rose-500 transition text-xs font-bold uppercase tracking-widest p-5 border border-white/5 rounded-xl justify-center bg-white/[0.02] hover:bg-white/[0.05] group">
                            <i class="fas fa-external-link-alt group-hover:scale-110 transition"></i> Acessar Fonte Original / Documentação
                        </a>
                    </div>
                </div>
            </div>

            <!-- Mobile Bottom Tabs (Navegação interna do Modal) -->
            <div class="md:hidden absolute bottom-0 left-0 w-full bg-slate-950 border-t border-white/10 flex justify-around p-2 z-20">
                <button class="flex flex-col items-center gap-1 p-2 text-rose-500 modal-tab-btn" data-tab="content">
                    <i class="fas fa-book-open"></i> <span class="text-[10px] font-bold">Aula</span>
                </button>
                <button class="flex flex-col items-center gap-1 p-2 text-slate-500 modal-tab-btn" data-tab="tools">
                    <i class="fas fa-toolbox"></i> <span class="text-[10px] font-bold">Ferramentas</span>
                </button>
                <button class="flex flex-col items-center gap-1 p-2 text-slate-500 modal-tab-btn" data-tab="nav">
                    <i class="fas fa-step-forward"></i> <span class="text-[10px] font-bold">Navegar</span>
                </button>
            </div>

            <!-- Footer Navegação (Desktop Only) -->
            <div class="hidden md:flex absolute bottom-0 left-0 w-full p-4 border-t border-white/5 bg-slate-950/95 backdrop-blur justify-end items-center z-10 pl-[25rem]">
                 <div class="flex gap-4">
                    <button id="btn-prev-ep" class="text-slate-400 hover:text-white text-xs font-bold uppercase tracking-widest flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition group touch-target">
                        <i class="fas fa-chevron-left group-hover:-translate-x-1 transition"></i> Anterior
                    </button>
                    <button id="btn-next-ep" class="text-slate-400 hover:text-white text-xs font-bold uppercase tracking-widest flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition group touch-target">
                        Próximo <i class="fas fa-chevron-right group-hover:translate-x-1 transition"></i>
                    </button>
                 </div>
            </div>
        </div>
    </div>

    <!-- MENTOR IA CONECTADO -->
    <div id="chat-window" class="fixed bottom-0 right-0 md:bottom-6 md:right-6 w-full md:w-[480px] h-[85vh] md:h-[650px] bg-[#0a0a0a] md:rounded-3xl shadow-2xl z-[70] transform translate-y-[110%] transition-transform duration-500 border border-white/10 flex flex-col overflow-hidden" role="dialog" aria-label="Chat com Mentor IA">
        <div class="p-5 bg-gradient-to-r from-rose-700 to-rose-600 flex justify-between items-center md:rounded-t-3xl shadow-lg cursor-pointer hover:brightness-110 transition touch-target" id="chat-header">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white shadow-inner border border-white/20">
                    <i class="fas fa-globe"></i>
                </div>
                <div>
                    <h3 class="font-bold text-white text-sm">Mentor Conectado</h3>
                    <p class="text-[9px] text-white/90 uppercase tracking-wider font-bold flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> Google Search Ativo
                    </p>
                </div>
            </div>
            <i class="fas fa-chevron-down text-white/80"></i>
        </div>
        
        <div id="chat-messages" class="flex-grow overflow-y-auto p-5 space-y-5 bg-[#050505] custom-scrollbar" aria-live="polite">
            <div class="flex gap-4 animate-fade-in">
                <div class="w-8 h-8 rounded-full bg-rose-600 flex-shrink-0 flex items-center justify-center text-xs text-white shadow-lg shadow-rose-900/50">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-white/5 text-sm text-slate-300 max-w-[85%] shadow-md">
                    Olá! Estou conectado à internet. Posso pesquisar datas atualizadas do SISU, temas recentes para redação ou explicar conceitos complexos.
                </div>
            </div>
        </div>
        
        <div class="p-4 bg-slate-900 border-t border-white/5">
            <form id="chat-form" class="relative">
                <label for="chat-input" class="visually-hidden">Digite sua mensagem</label>
                <input type="text" id="chat-input" placeholder="Pergunte sobre atualidades..." class="w-full bg-black border border-slate-700 rounded-xl py-3.5 pl-5 pr-12 text-sm text-white focus:outline-none focus:border-rose-500 focus:ring-1 focus:ring-rose-500 transition shadow-inner">
                <button type="submit" class="absolute right-2 top-2 bg-rose-600 hover:bg-rose-500 w-9 h-9 rounded-lg text-white flex items-center justify-center transition shadow-lg hover:scale-105 active:scale-95 touch-target" aria-label="Enviar Mensagem">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- FERRAMENTAS MODAL -->
    <div id="tools-modal" class="fixed inset-0 z-[65] hidden bg-black/90 backdrop-blur-md items-center justify-center p-4" aria-modal="true" role="dialog" aria-labelledby="tools-title">
        <div class="bg-slate-900 w-full max-w-2xl rounded-3xl border border-white/10 p-0 relative animate-fade-in overflow-hidden flex flex-col max-h-[90vh] shadow-2xl">
            <div class="p-5 border-b border-white/10 flex justify-between items-center bg-slate-950">
                <h2 id="tools-title" class="text-lg font-bold text-white flex items-center gap-3"><i class="fas fa-toolbox text-rose-500"></i> Ferramentas de Estudo</h2>
                <button id="btn-close-tools" class="text-slate-400 hover:text-white transition p-2 hover:bg-white/10 rounded-full touch-target" aria-label="Fechar"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex border-b border-white/10 text-[10px] md:text-xs font-bold uppercase tracking-widest bg-slate-900">
                <button class="tool-tab flex-1 py-4 text-white border-b-2 border-rose-500 transition hover:bg-slate-800 focus:outline-none touch-target" data-tool="calc">Calculadora</button>
                <button class="tool-tab flex-1 py-4 text-slate-400 hover:text-white transition hover:bg-slate-800 focus:outline-none touch-target" data-tool="sisu">Simulador</button>
                <button class="tool-tab flex-1 py-4 text-slate-400 hover:text-white transition hover:bg-slate-800 focus:outline-none touch-target" data-tool="crono">Cronograma</button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar bg-[#0a0a0a]">
                <!-- Calculadora -->
                <div id="tool-calc" class="tool-content space-y-6">
                    <h3 class="text-white font-bold text-lg mb-2">Calculadora Média Simples</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <div><label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Ling</label><input id="nota-lin" type="number" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-sm focus:border-rose-500 outline-none transition" placeholder="0"></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Hum</label><input id="nota-hum" type="number" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-sm focus:border-rose-500 outline-none transition" placeholder="0"></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Nat</label><input id="nota-nat" type="number" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-sm focus:border-rose-500 outline-none transition" placeholder="0"></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Mat</label><input id="nota-mat" type="number" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-sm focus:border-rose-500 outline-none transition" placeholder="0"></div>
                        <div><label class="text-[10px] uppercase font-bold text-rose-500 block mb-1">Red</label><input id="nota-red" type="number" class="w-full bg-slate-900 border border-rose-500/50 rounded-lg p-3 text-white text-sm focus:border-rose-500 outline-none transition" placeholder="0"></div>
                    </div>
                    <button id="btn-calc-media" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-4 rounded-xl mt-4 shadow-lg shadow-rose-900/20 hover:scale-[1.02] transition touch-target">CALCULAR RESULTADO</button>
                    <div id="resultado-media" class="hidden text-center p-6 bg-slate-900 rounded-xl mt-6 border border-white/5 animate-fade-in"><span class="text-xs text-slate-400 block uppercase tracking-widest mb-1">Sua Média Estimada</span><span class="text-4xl font-black text-white" id="valor-media">000.0</span></div>
                </div>
                <!-- SISU e Cronograma (Simplificados para manter estrutura) -->
                <div id="tool-sisu" class="tool-content hidden space-y-6"><h3 class="text-white font-bold text-lg mb-2">Simulador</h3><input id="sisu-curso" placeholder="Curso" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white text-sm"><input id="sisu-nota" type="number" placeholder="Nota" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white text-sm"><button id="btn-simular-sisu" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl mt-2 touch-target">SIMULAR</button><div id="sisu-result" class="hidden p-5 bg-slate-800 rounded-xl border border-white/5 text-sm text-slate-300"></div></div>
                <div id="tool-crono" class="tool-content hidden space-y-6"><h3 class="text-white font-bold text-lg mb-2">Gerador</h3><input type="number" value="4" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white"><button id="btn-gerar-crono" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl mt-2 touch-target">GERAR CICLO</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- CENTRALIZED STATE MANAGEMENT ---
        const AppState = {
            progress: JSON.parse(localStorage.getItem('mozer_progress')) || [],
            favorites: JSON.parse(localStorage.getItem('mozer_favs')) || [],
            notes: JSON.parse(localStorage.getItem('mozer_notes')) || {},
            streak: parseInt(localStorage.getItem('mozer_streak')) || 0,
            lastLogin: localStorage.getItem('mozer_last_login'),
            currentEpisode: null,
            pomodoro: { time: 25 * 60, interval: null, running: false }
        };

        // --- CONSTANTS ---
        // ATENÇÃO: Em produção real, a API Key deve ficar no backend (Node.js/Python) e não aqui.
        // Como este é um arquivo demonstrativo único, ela está aqui, mas isso é inseguro.
        const CONSTANTS = {
            API_KEY: "", // <--- INSIRA SUA API KEY AQUI
            CATALOG: [
                { 
                    id: "t1", title: "T1: O Sistema", desc: "Regras do jogo: TRI, SISU, FIES e Cotas.", 
                    episodes: [
                        { id: "1-1", title: "O Código Secreto TRI", content: "<p>O ENEM não é uma prova de soma, é uma prova de coerência.</p><h3 class='text-white font-bold mt-4'>O Algoritmo:</h3><p>Se você erra questões fáceis e acerta difíceis, sua nota cai.</p>", videoQuery: "como funciona TRI enem", sourceLink: "https://www.gov.br/inep/" },
                        { id: "1-2", title: "SISU, ProUni e FIES", content: "<h3>SISU</h3><p>Vagas em Públicas.</p><h3>ProUni</h3><p>Bolsas em Privadas.</p>", videoQuery: "diferença sisu prouni fies", sourceLink: "https://acessounico.mec.gov.br/" },
                        { id: "1-3", title: "Calendário de Guerra", content: "<p>Não perca as datas de inscrição.</p>", videoQuery: "calendario enem 2026", sourceLink: "https://enem.inep.gov.br/" }
                    ]
                },
                { 
                    id: "t2", title: "T2: Como Estudar", desc: "Neurociência e técnicas de alta performance.", 
                    episodes: [
                        { id: "2-1", title: "Estudo Ativo vs Passivo", content: "<p>Use Flashcards e questões.</p>", videoQuery: "estudo ativo", sourceLink: "#" },
                        { id: "2-2", title: "Técnica Pomodoro", content: "<p>25 min foco / 5 min pausa.</p>", videoQuery: "pomodoro timer", sourceLink: "#" }
                    ]
                },
                { 
                    id: "t3", title: "T3: Redação 1000", desc: "Estrutura, Repertório e GOMIF.", 
                    episodes: [
                        { id: "3-1", title: "A Fórmula GOMIF", content: "<p>Conclusão: Agente, Ação, Meio, Efeito, Detalhe.</p>", videoQuery: "gomif redação", sourceLink: "#" },
                        { id: "3-2", title: "Repertório: Desigualdade", content: "<h3>Filmes:</h3><p>Parasita, Que Horas Ela Volta?</p>", videoQuery: "repertorio redação desigualdade", sourceLink: "#" }
                    ]
                },
                // Adicionei placeholders para as outras temporadas para manter o código limpo, 
                // mas a lógica suporta todas as 10 temporadas normalmente.
                { id: "t4", title: "T4: Exatas", desc: "Matemática e Natureza.", episodes: [{id: "4-1", title: "Matemática Básica", content: "Regra de 3 e Porcentagem.", videoQuery: "matematica basica enem", sourceLink: "#"}] },
                { id: "t5", title: "T5: Humanas", desc: "História e Geografia.", episodes: [{id: "5-1", title: "Brasil Colônia", content: "Ciclos econômicos.", videoQuery: "brasil colonia", sourceLink: "#"}] },
                { id: "t6", title: "T6: Saúde Mental", desc: "Ansiedade e Sono.", episodes: [{id: "6-1", title: "Higiene do Sono", content: "Durma bem.", videoQuery: "sono estudos", sourceLink: "#"}] },
                { id: "t7", title: "T7: Reta Final", desc: "Simulados.", episodes: [{id: "7-1", title: "Estratégia de Prova", content: "Comece pelas fáceis.", videoQuery: "estrategia enem", sourceLink: "#"}] },
                { id: "t8", title: "T8: Dia da Prova", desc: "Kit Sobrevivência.", episodes: [{id: "8-1", title: "O que levar", content: "Caneta preta e água.", videoQuery: "o que levar enem", sourceLink: "#"}] },
                { id: "t9", title: "T9: Pós-Prova", desc: "TRI e SISU.", episodes: [{id: "9-1", title: "Como usar a nota", content: "Simuladores.", videoQuery: "sisu simulador", sourceLink: "#"}] },
                { id: "t10", title: "T10: A Glória", desc: "Matrícula.", episodes: [{id: "10-1", title: "Documentação", content: "Histórico e RG.", videoQuery: "documentos faculdade", sourceLink: "#"}] }
            ]
        };

        // --- CORE FUNCTIONS ---

        function init() {
            document.getElementById('catalog-loader').style.display = 'none';
            renderCatalog(CONSTANTS.CATALOG);
            updateUIState();
            checkStreak();
            setupEventListeners();
        }

        // Renderização Segura (Evitando innerHTML com dados de usuário, mas usando template literals para estrutura estática)
        function renderCatalog(data) {
            const container = document.getElementById('catalogo');
            container.innerHTML = data.map(season => `
                <section class="animate-fade-in">
                    <div class="flex items-end gap-4 mb-8 border-b border-white/5 pb-4">
                        <div class="h-10 w-1.5 bg-gradient-to-b from-rose-600 to-orange-500 rounded-full shadow-[0_0_15px_rgba(225,29,72,0.5)]"></div>
                        <div>
                            <h2 class="text-3xl md:text-4xl font-black text-white italic tracking-tight">${season.title}</h2>
                            <p class="text-sm text-slate-400 font-medium mt-1">${season.desc}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${season.episodes.map(ep => createEpisodeCard(season.id, ep)).join('')}
                    </div>
                </section>
            `).join('');
        }

        function createEpisodeCard(seasonId, ep) {
            return `
                <article class="episode-card bg-slate-900/50 backdrop-blur-sm p-6 rounded-2xl border border-white/5 cursor-pointer card-hover group relative overflow-hidden focus:outline-none focus:ring-2 focus:ring-rose-500 hover:bg-slate-800/80 transition-all duration-300" 
                    role="button" tabindex="0" data-sid="${seasonId}" data-eid="${ep.id}">
                    <div class="absolute inset-0 bg-gradient-to-br from-rose-600/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    <div class="flex justify-between items-start mb-5 relative z-10">
                        <span class="text-rose-400 font-black text-[10px] tracking-[0.2em] uppercase bg-rose-500/10 px-3 py-1.5 rounded-lg border border-rose-500/20 shadow-sm">EP ${ep.id.split('-')[1]}</span>
                        <div class="flex gap-3">
                            <i id="fav-icon-${ep.id}" class="fas fa-heart text-rose-500 text-sm hidden animate-fade-in shadow-[0_0_10px_rgba(225,29,72,0.5)]"></i>
                            <div class="relative"><i id="check-${ep.id}" class="far fa-circle text-slate-600 text-xl transition duration-300 group-hover:text-slate-400"></i></div>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-3 leading-tight pr-4 group-hover:text-rose-200 transition relative z-10">${ep.title}</h3>
                    <div class="w-full h-1.5 bg-slate-800 rounded-full mt-6 overflow-hidden relative z-10">
                        <div id="prog-${ep.id}" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 w-0 transition-all duration-1000 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></div>
                    </div>
                </article>
            `;
        }

        // --- EVENT HANDLING ---
        function setupEventListeners() {
            // Delegação de Eventos para Cards de Episódio
            document.getElementById('catalogo').addEventListener('click', (e) => {
                const card = e.target.closest('.episode-card');
                if (card) openEpisode(card.dataset.sid, card.dataset.eid);
            });

            // Menu Mobile
            document.getElementById('btn-mobile-menu').addEventListener('click', toggleMobileMenu);
            document.getElementById('btn-close-mobile').addEventListener('click', toggleMobileMenu);
            document.getElementById('mobile-menu-overlay').addEventListener('click', toggleMobileMenu);

            // Ferramentas
            document.getElementById('btn-tools-desktop').addEventListener('click', toggleTools);
            document.getElementById('btn-close-tools').addEventListener('click', toggleTools);
            document.querySelectorAll('.tool-tab').forEach(btn => {
                btn.addEventListener('click', (e) => switchTool(e.target.dataset.tool));
            });

            // Chat
            document.getElementById('btn-chat-desktop').addEventListener('click', toggleChat);
            document.getElementById('chat-header').addEventListener('click', toggleChat);
            document.getElementById('chat-form').addEventListener('submit', handleChatSubmit);
            document.getElementById('btn-chat-hero').addEventListener('click', toggleChat);

            // Modal Episódio
            document.getElementById('btn-close-modal-desktop').addEventListener('click', closeModal);
            document.getElementById('btn-close-modal-mobile').addEventListener('click', closeModal);
            document.getElementById('modal-backdrop').addEventListener('click', closeModal);
            document.getElementById('btn-fullscreen').addEventListener('click', () => document.getElementById('modal-content-box').classList.toggle('fullscreen-modal'));
            
            // Ações Modal
            document.getElementById('btn-concluir').addEventListener('click', toggleCompleteEpisode);
            document.getElementById('btn-fav').addEventListener('click', toggleFavoriteEpisode);
            document.getElementById('btn-save-notes').addEventListener('click', downloadNotes);
            document.getElementById('user-notes').addEventListener('input', saveNotes);
            
            // Pomodoro
            document.getElementById('pomo-btn').addEventListener('click', togglePomodoro);
            document.getElementById('pomo-reset').addEventListener('click', resetPomodoro);

            // Mobile Modal Tabs
            document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchMobileModalTab(e.currentTarget.dataset.tab));
            });
            
            // Calculadoras
            document.getElementById('btn-calc-media').addEventListener('click', calcularMedia);
            document.getElementById('btn-simular-sisu').addEventListener('click', () => showToast("Simulação concluída! (Demo)", "success"));
            document.getElementById('btn-gerar-crono').addEventListener('click', () => showToast("Cronograma gerado!", "success"));

            // Search
            document.getElementById('desktop-search').addEventListener('input', handleSearch);
        }

        // --- MODAL LOGIC (MOBILE FIRST REFACTOR) ---
        function openEpisode(sId, eId) {
            const season = CONSTANTS.CATALOG.find(s => s.id === sId);
            const ep = season.episodes.find(e => e.id === eId);
            AppState.currentEpisode = ep;

            // Populate Content
            document.getElementById('modal-tag').textContent = season.title;
            document.getElementById('modal-tag-mobile').textContent = season.title;
            document.getElementById('modal-title').textContent = ep.title;
            document.getElementById('modal-body').innerHTML = ep.content;
            document.getElementById('modal-link-video').href = `https://www.youtube.com/results?search_query=${encodeURIComponent(ep.videoQuery)}`;
            
            // Restore User Data
            document.getElementById('user-notes').value = AppState.notes[eId] || "";
            updateModalStatusUI();

            // Show Modal
            const modal = document.getElementById('episode-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            
            // Mobile Tab Reset
            switchMobileModalTab('content');

            // Focus Trap (Basic Implementation)
            document.getElementById('btn-close-modal-desktop').focus();
        }

        function switchMobileModalTab(tabName) {
            const sidebar = document.getElementById('modal-sidebar');
            const content = document.getElementById('modal-main-content');
            
            // Reset visibility classes for mobile logic
            if (window.innerWidth < 768) {
                if (tabName === 'tools') {
                    sidebar.classList.remove('hidden');
                    sidebar.classList.add('flex');
                    content.classList.add('hidden');
                } else if (tabName === 'content') {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('flex');
                    content.classList.remove('hidden');
                } else if (tabName === 'nav') {
                    showToast("Use os botões Anterior/Próximo (Demo)");
                }
            }
            
            // Update Active State on Buttons
            document.querySelectorAll('.modal-tab-btn').forEach(btn => {
                if(btn.dataset.tab === tabName) {
                    btn.classList.add('text-rose-500');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('text-rose-500');
                    btn.classList.add('text-slate-500');
                }
            });
        }

        function closeModal() {
            const modal = document.getElementById('episode-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            resetPomodoro();
        }

        // --- STATE & UI UPDATES ---
        function updateUIState() {
            // Progress
            AppState.progress.forEach(id => {
                const el = document.getElementById(`check-${id}`);
                const bar = document.getElementById(`prog-${id}`);
                if(el) { el.className = "fas fa-check-circle text-green-500 text-xl"; bar.style.width = "100%"; }
            });

            // Favorites
            AppState.favorites.forEach(id => {
                const el = document.getElementById(`fav-icon-${id}`);
                if(el) el.classList.remove('hidden');
            });

            // Global Stats
            let totalEps = 0; CONSTANTS.CATALOG.forEach(s => totalEps += s.episodes.length);
            const percent = Math.round((AppState.progress.length / totalEps) * 100);
            document.getElementById('global-progress-line').style.width = `${percent}%`;
            document.getElementById('mobile-progress-bar').style.width = `${percent}%`;
            document.getElementById('mobile-progress-text').textContent = `${percent}%`;
            document.getElementById('user-level').textContent = percent > 80 ? "Mestre" : percent > 30 ? "Veterano" : "Novato";
        }

        function toggleCompleteEpisode() {
            const id = AppState.currentEpisode.id;
            const idx = AppState.progress.indexOf(id);
            
            if (idx === -1) {
                AppState.progress.push(id);
                showToast("Episódio Concluído! +50XP");
            } else {
                AppState.progress.splice(idx, 1);
            }
            
            saveState();
            updateUIState();
            updateModalStatusUI();
        }

        function toggleFavoriteEpisode() {
            const id = AppState.currentEpisode.id;
            const idx = AppState.favorites.indexOf(id);
            
            if (idx === -1) {
                AppState.favorites.push(id);
                showToast("Adicionado aos Favoritos");
            } else {
                AppState.favorites.splice(idx, 1);
                showToast("Removido dos Favoritos", "error");
            }
            
            saveState();
            updateUIState(); // Refresh catalog icons
            updateModalStatusUI();
        }

        function updateModalStatusUI() {
            const id = AppState.currentEpisode.id;
            const isDone = AppState.progress.includes(id);
            const isFav = AppState.favorites.includes(id);

            const btnDone = document.getElementById('btn-concluir');
            btnDone.className = isDone 
                ? "w-full py-4 bg-green-600 text-white rounded-xl font-bold text-xs uppercase tracking-widest transition flex items-center justify-center gap-3 touch-target"
                : "w-full py-4 bg-slate-800 hover:bg-green-600 text-white rounded-xl font-bold text-xs uppercase tracking-widest transition flex items-center justify-center gap-3 border border-white/5 shadow-lg group touch-target";
            btnDone.innerHTML = isDone ? '<i class="fas fa-check"></i> Concluído' : '<i class="far fa-circle group-hover:scale-110 transition"></i> Concluir Episódio';

            const btnFav = document.getElementById('btn-fav');
            if (isFav) {
                btnFav.classList.add('text-rose-500', 'bg-rose-500/10');
                btnFav.innerHTML = '<i class="fas fa-heart"></i> Favorito';
            } else {
                btnFav.classList.remove('text-rose-500', 'bg-rose-500/10');
                btnFav.innerHTML = '<i class="far fa-heart"></i> Favoritar';
            }
        }

        function saveNotes(e) {
            if(!AppState.currentEpisode) return;
            AppState.notes[AppState.currentEpisode.id] = e.target.value;
            localStorage.setItem('mozer_notes', JSON.stringify(AppState.notes));
        }

        function saveState() {
            localStorage.setItem('mozer_progress', JSON.stringify(AppState.progress));
            localStorage.setItem('mozer_favs', JSON.stringify(AppState.favorites));
        }

        function checkStreak() {
            const today = new Date().toDateString();
            if (AppState.lastLogin !== today) {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if (AppState.lastLogin === yesterday.toDateString()) {
                    AppState.streak++;
                } else {
                    AppState.streak = 1;
                }
                localStorage.setItem('mozer_last_login', today);
                localStorage.setItem('mozer_streak', AppState.streak);
            }
            document.getElementById('streak-counter').textContent = AppState.streak;
        }

        // --- CHAT LOGIC ---
        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            const box = document.getElementById('chat-messages');
            box.innerHTML += `<div class="flex gap-4 justify-end animate-fade-in"><div class="bg-gradient-to-r from-rose-600 to-rose-500 p-4 rounded-2xl rounded-tr-none text-sm text-white max-w-[85%] shadow-lg">${msg}</div></div>`;
            input.value = "";
            box.scrollTop = box.scrollHeight;

            // Loading
            const loadId = "loading-" + Date.now();
            box.innerHTML += `<div id="${loadId}" class="flex gap-4 animate-fade-in"><div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center"><i class="fas fa-circle-notch fa-spin text-slate-500"></i></div><div class="bg-slate-900 p-4 rounded-2xl rounded-tl-none border border-white/5 text-sm text-slate-400">Pesquisando...</div></div>`;
            box.scrollTop = box.scrollHeight;

            if (!CONSTANTS.API_KEY) {
                setTimeout(() => {
                    document.getElementById(loadId).remove();
                    addBotMessage("⚠️ <strong>Modo Demo:</strong> Configure a API Key no código para ativar a IA real.");
                }, 1000);
                return;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONSTANTS.API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: msg }] }], tools: [{ google_search: {} }] })
                });
                const data = await response.json();
                document.getElementById(loadId).remove();
                
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sem resposta.";
                const meta = data.candidates?.[0]?.groundingMetadata;
                let sources = "";
                
                if (meta?.groundingChunks) {
                    sources = `<div class="mt-4 pt-3 border-t border-white/10 flex flex-wrap gap-2">` + 
                    meta.groundingChunks.map(c => c.web?.uri ? `<a href="${c.web.uri}" target="_blank" class="source-chip"><i class="fas fa-link"></i> ${c.web.title||'Fonte'}</a>` : '').join('') + 
                    `</div>`;
                }
                
                addBotMessage(marked.parse(text) + sources);
            } catch (err) {
                document.getElementById(loadId).remove();
                addBotMessage("Erro de conexão. Verifique sua chave API.");
            }
        }

        function addBotMessage(html) {
            const box = document.getElementById('chat-messages');
            box.innerHTML += `<div class="flex gap-4 animate-fade-in"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex-shrink-0 flex items-center justify-center text-xs text-white shadow-lg"><i class="fas fa-globe"></i></div><div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-white/5 text-sm text-slate-300 max-w-[90%] shadow-md prose-chat">${html}</div></div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- UTILS ---
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            toast.className = `${color} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 text-sm font-bold animate-fade-in border border-white/10 backdrop-blur-md`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const overlay = document.getElementById('mobile-menu-overlay');
            const isClosed = menu.classList.contains('translate-x-full');
            
            if (isClosed) {
                menu.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                menu.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function toggleTools() {
            const modal = document.getElementById('tools-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
        }

        function toggleChat() {
            const chat = document.getElementById('chat-window');
            chat.classList.toggle('translate-y-[110%]');
            chat.classList.toggle('translate-y-0');
        }

        function switchTool(toolId) {
            document.querySelectorAll('.tool-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tool-${toolId}`).classList.remove('hidden');
            
            document.querySelectorAll('.tool-tab').forEach(btn => {
                if(btn.dataset.tool === toolId) {
                    btn.classList.add('text-white', 'border-rose-500');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('text-white', 'border-rose-500');
                    btn.classList.add('text-slate-400');
                }
            });
        }

        function togglePomodoro() {
            const btn = document.getElementById('pomo-btn');
            if (AppState.pomodoro.running) {
                clearInterval(AppState.pomodoro.interval);
                AppState.pomodoro.running = false;
                btn.textContent = "RETOMAR";
                btn.className = "flex-1 py-2 bg-slate-800 text-[10px] text-rose-400 font-bold rounded-lg hover:bg-slate-700 transition uppercase tracking-wide touch-target";
            } else {
                AppState.pomodoro.running = true;
                btn.textContent = "PAUSAR";
                btn.className = "flex-1 py-2 bg-rose-600 text-[10px] text-white font-bold rounded-lg hover:bg-rose-500 transition uppercase tracking-wide touch-target";
                AppState.pomodoro.interval = setInterval(() => {
                    AppState.pomodoro.time--;
                    const m = Math.floor(AppState.pomodoro.time / 60).toString().padStart(2, '0');
                    const s = (AppState.pomodoro.time % 60).toString().padStart(2, '0');
                    document.getElementById('pomo-display').textContent = `${m}:${s}`;
                    if (AppState.pomodoro.time <= 0) {
                        resetPomodoro();
                        showToast("Tempo Esgotado!");
                    }
                }, 1000);
            }
        }

        function resetPomodoro() {
            clearInterval(AppState.pomodoro.interval);
            AppState.pomodoro.running = false;
            AppState.pomodoro.time = 25 * 60;
            document.getElementById('pomo-display').textContent = "25:00";
            document.getElementById('pomo-btn').textContent = "INICIAR";
            document.getElementById('pomo-btn').className = "flex-1 py-2 bg-slate-800 text-[10px] text-rose-400 font-bold rounded-lg hover:bg-slate-700 transition uppercase tracking-wide touch-target";
        }
        
        function downloadNotes() {
            const val = document.getElementById('user-notes').value;
            if(!val) return showToast("Nota vazia!", "error");
            const blob = new Blob([val], {type: "text/plain"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `Notas_${AppState.currentEpisode.id}.txt`;
            a.click();
        }

        function calcularMedia() {
            const ids = ['lin','hum','nat','mat','red'];
            const vals = ids.map(id => parseFloat(document.getElementById(`nota-${id}`).value)||0);
            const media = (vals.reduce((a,b)=>a+b,0)/5).toFixed(1);
            document.getElementById('valor-media').textContent = media;
            document.getElementById('resultado-media').classList.remove('hidden');
            showToast("Média calculada!");
        }

        function handleSearch(e) {
            const term = e.target.value.toLowerCase();
            if(!term) return renderCatalog(CONSTANTS.CATALOG);
            
            const filtered = CONSTANTS.CATALOG.map(s => ({
                ...s, 
                episodes: s.episodes.filter(ep => ep.title.toLowerCase().includes(term) || ep.content.toLowerCase().includes(term))
            })).filter(s => s.episodes.length > 0);
            
            renderCatalog(filtered);
        }

        // --- INIT ---
        window.onload = init;

    </script>
</body>
</html>
